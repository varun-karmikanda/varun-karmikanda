name: Update README with fresh stats

# ensure the workflow can push changes
permissions:
  contents: write

on:
  schedule:
    - cron: '0 0 * * *'   # runs daily at 00:00 UTC (change if you want)
  workflow_dispatch:      # allows manual run from Actions tab

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Refresh README image URL
        run: |
          python - <<'PY'
          import re, time, pathlib, sys
          p = pathlib.Path('README.md')
          if not p.exists():
              print("README.md not found â€” nothing to do.")
              sys.exit(0)
          s = p.read_text(encoding='utf8')
          ts = str(int(time.time()))
          # find the first occurrence of the top-langs API URL (adjust username if needed)
          pattern = re.compile(r'(https://varun-karmikanda-github-stats\.vercel\.app/api/top-langs/[^"\\s]*)', re.IGNORECASE)
          m = pattern.search(s)
          if not m:
              print("No top-langs URL found in README.md")
              sys.exit(0)
          base = m.group(1).split('?')[0]
          new_url = base + '?username=varun-karmikanda&layout=compact&theme=tokyonight&hide_border=true&langs_count=8&count_private=true&v=' + ts
          new_s = s[:m.start(1)] + new_url + s[m.end(1):]
          p.write_text(new_s, encoding='utf8')
          print("Updated README with timestamp:", ts)
          PY

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if git status --porcelain | grep -q '.'; then
            git add README.md
            git commit -m "ðŸ”„ Refresh stats in README [skip ci]" || echo "Nothing to commit"
            git push
          else
            echo "No changes detected"
          fi
